"use strict";function MatchupFetcher(){var e=this;e.imagesLoaded=0,e.TOTAL_IMAGES=3,e.righteous_indignation_time=3e5,e.matchDetails,e.ppt,e.REFRESH_TIME=1e4,e.guildDetails={},e.updateCircles={},e.kdBarChart=null;e._preInit=function(){window.wvwPPTCanvases=[],e.imageRedSmall=new Image,e.imageRedSmall.onload=function(){e._imageLoaded()},e.imageRedSmall.src=wvwMapConfig.installDirectory+"/images/redGlobe-med.png",e.imageBlueSmall=new Image,e.imageBlueSmall.onload=function(){e._imageLoaded()},e.imageBlueSmall.src=wvwMapConfig.installDirectory+"/images/blueGlobe-med.png",e.imageGreenSmall=new Image,e.imageGreenSmall.onload=function(){e._imageLoaded()},e.imageGreenSmall.src=wvwMapConfig.installDirectory+"/images/greenGlobe-med.png"},e._init=function(){e._initPPTChart(),e._initKDBar(),e._updateMatchup(),e._updateLoop(),e._updateCooldownCircles()},e._imageLoaded=function(){++e.imagesLoaded>=e.TOTAL_IMAGES&&e._init()},e._initKDBar=function(){var a=document.getElementById("kd-bar-chart"),t=[],r=[],i=[];$.each(e.mapNames,function(e,a){i.push(e)}),$.each(e.baseColors,function(a,i){var d={colorId:a,dataType:"kills",stack:"kills",backgroundColor:"rgba("+i+",1)",borderColor:"rgba("+i+",1)",borderWidth:2,data:[]},n={colorId:a,dataType:"deaths",stack:"deaths",backgroundColor:"rgba("+e.baseDarkColors[a]+",1)",borderColor:"rgba("+e.baseDarkColors[a]+",1)",borderWidth:2,data:[]};$.each(e.mapNames,function(e,a){d.data.push(0),n.data.push(0)}),r.push(d),t.push(n)}),Array.prototype.push.apply(r,t);var d={labels:i,datasets:r},n={legend:{display:!1},scales:{yAxes:[{stacked:!0,gridLines:{display:!0,color:"rgba(10, 14, 15,1)"},ticks:{fontColor:"rgba(255, 255, 255,1)",callback:function(e,a,t){return abbreviate(e)}}}],xAxes:[{stacked:!0,gridLines:{display:!0,color:"rgba(10, 14, 15,1)"},ticks:{fontColor:"rgba(255, 255, 255,1)"}}]},tooltips:{mode:"index",intersect:!1,position:"average"},responsive:!0};e.kdBarChart=new Chart(a,{type:"bar",data:d,options:n})},e._initPPTChart=function(){$(".wvw-ppt-canvas").each(function(){var a,t,r,i=this.getContext("2d"),d={borderWidth:3,type:"pie",animationSteps:40,responsive:!0,data:{labels:["Red","Blue","Green"],datasets:[{data:[100,100,100],backgroundColor:[a=i.createPattern(e.imageRedSmall,"no-repeat"),t=i.createPattern(e.imageBlueSmall,"no-repeat"),r=i.createPattern(e.imageGreenSmall,"no-repeat")],borderColor:"rgba(0,0,0,1)"}]},options:{tooltips:{enabled:!1},legend:{display:!1,responsive:!0}}},n=new Chart(i,d);window.wvwPPTCanvases.push(n)})},e._updateLoop=function(){setTimeout(function(){e._updateMatchup(),e._updateLoop()},e.REFRESH_TIME)},e._updateMatchup=function(){$.getJSON("https://api.guildwars2.com/v2/wvw/matches?world="+wvwMapConfig.world,function(a){e.matchDetails=a,e._processMatchupData(),e._draw()})},e._processMatchupData=function(){e._calculatePPT()},e._calculatePPT=function(){for(var a=e.matchDetails.maps,t=[0,0,0],r=0;r<a.length;r++)for(var i=a[r].objectives,d=0;d<i.length;d++){var n=i[d];void 0!==e.colorToId[n.owner]&&(t[e.colorToId[n.owner]]+=n.points_tick)}e.ppt=t},e._draw=function(){e._drawScoreDetails(),e._updateKDBarChart(),e._drawMapMarkers()},e._drawScoreDetails=function(){var a=e.matchDetails.victory_points,t=$(".wvw-victory-points");t.find(".wvw-number-label-red").html(a.red),t.find(".wvw-number-label-blue").html(a.blue),t.find(".wvw-number-label-green").html(a.green),$(".wvw-bar-text-green").html(e.world_names[e.matchDetails.worlds.green][1]),$(".wvw-bar-text-blue").html(e.world_names[e.matchDetails.worlds.blue][1]),$(".wvw-bar-text-red").html(e.world_names[e.matchDetails.worlds.red][1]),$(".wvw-green-world-name-short").html(e.world_names[e.matchDetails.worlds.green][0]),$(".wvw-blue-world-name-short").html(e.world_names[e.matchDetails.worlds.blue][0]),$(".wvw-red-world-name-short").html(e.world_names[e.matchDetails.worlds.red][0]);var r=Math.max(a.red,a.blue,a.green);t.find(".wvw-bar-red").width(a.red/r*100+"%"),t.find(".wvw-bar-blue").width(a.blue/r*100+"%"),t.find(".wvw-bar-green").width(a.green/r*100+"%"),t.find(".wvw-diff-number-red").html(a.red==r?"Lead":"-"+(r-a.red)),t.find(".wvw-diff-number-blue").html(a.blue==r?"Lead":"-"+(r-a.blue)),t.find(".wvw-diff-number-green").html(a.green==r?"Lead":"-"+(r-a.green)),$(".wvw-ppt-number-red").html(e.ppt[0]),$(".wvw-ppt-number-blue").html(e.ppt[1]),$(".wvw-ppt-number-green").html(e.ppt[2]);var i=e.matchDetails.skirmishes[e.matchDetails.skirmishes.length-1].scores,d=Math.max(i.red,i.blue,i.green),n=$(".wvw-skirmish-score");n.find(".wvw-bar-red").width(i.red/d*100+"%"),n.find(".wvw-bar-blue").width(i.blue/d*100+"%"),n.find(".wvw-bar-green").width(i.green/d*100+"%"),n.find(".wvw-number-label-red").html(i.red),n.find(".wvw-number-label-blue").html(i.blue),n.find(".wvw-number-label-green").html(i.green),n.find(".wvw-diff-number-red").html(i.red===d?"Lead":"-"+(d-i.red)),n.find(".wvw-diff-number-blue").html(i.blue===d?"Lead":"-"+(d-i.blue)),n.find(".wvw-diff-number-green").html(i.green===d?"Lead":"-"+(d-i.green));var o={Center:"eb",RedHome:"red",BlueHome:"blue",GreenHome:"green"};e._updateCombatWidget(".wvw-kd-total-widget",e.matchDetails.kills,e.matchDetails.deaths);for(s=0;s<e.matchDetails.maps.length;s++){var l=e.matchDetails.maps[s];e._updateCombatWidget(".wvw-kd-"+o[l.type]+"-widget",l.kills,l.deaths)}for(var s=0;s<window.wvwPPTCanvases.length;s++){var c=window.wvwPPTCanvases[s];c.data.datasets[0].data[0]=e.ppt[0],c.data.datasets[0].data[1]=e.ppt[1],c.data.datasets[0].data[2]=e.ppt[2],c.update()}},e._updateKDBarChart=function(){for(var a=[],t=0;t<e.matchDetails.maps.length;t++){var r=e.matchDetails.maps[t];a.push(r.type)}$.each(e.kdBarChart.data.datasets,function(a,t){t.data=[],t.label=e.world_names[e.matchDetails.worlds[t.colorId]][0]+" "+t.dataType;for(var r=0;r<e.matchDetails.maps.length;r++){var i=e.matchDetails.maps[r];i[t.dataType][t.colorId];t.dataType,t.data.push(i[t.dataType][t.colorId])}}),e.kdBarChart.update()},e._updateCombatWidget=function(e,a,t){var r=$(e);r.find(".wvw-kills-red").html(a.red),r.find(".wvw-kills-blue").html(a.blue),r.find(".wvw-kills-green").html(a.green),r.find(".wvw-deaths-red").html(t.red),r.find(".wvw-deaths-blue").html(t.blue),r.find(".wvw-deaths-green").html(t.green),r.find(".wvw-kd-red").html((a.red/t.red).toFixed(2)),r.find(".wvw-kd-blue").html((a.blue/t.blue).toFixed(2)),r.find(".wvw-kd-green").html((a.green/t.green).toFixed(2))},e._drawMapMarkers=function(){if(void 0!==wvwMap&&void 0!==wvwMap.getMap()&&void 0!==wvwMap.getObjectiveMarkers()){var a=wvwMap.getObjectiveMarkers();for(var t in e.matchDetails.maps){var r=e.matchDetails.maps[t].objectives;for(var i in r){var d=r[i],n=a[d.id];if(void 0!==n){var o=$(n._icon),l='<div class="wvw-objective-popup">\n                                            <table style="width: 100%"><tr><td class="wvw-objective-name">'+n.objectiveDetails.name+'</td>\n                                            <td><div class="objective-header-object" title="Point Per Tick"><div><div class="objective-ppt-label">'+d.points_tick+' +</div>\n                                            <img class="objective-ppt" src="'+wvwMapConfig.installDirectory+'/images/ppt.png"></div></div></td>\n                                            <td><div class="objective-header-object" title="Yaks Delivered"><div><div class="yaks-delivered-label">'+d.yaks_delivered+'</div>\n                                            <img class="yaks-delivered" src="'+wvwMapConfig.installDirectory+'/images/dolly.png"></div></div></td></tr></table>\n                                            <div class="wvw-objective-popup-container">';null!==d.claimed_by?(d.claimed_by in e.guildDetails||e._fetchGuildDetails(d.claimed_by,e._callbackGuildDetails(n,"Fetching guild name...")),o.find(".wvw-guild-icon-marker").show(),l+='<img class="claimed-by-img" src="http://guilds.gw2w2w.com/'+d.claimed_by+'.svg">'):o.find(".wvw-guild-icon-marker").hide(),l+='<div class="wvw-marker-popup-details">',null!==d.claimed_by&&(l+='<div class="claimed-by popup-detail">'+(d.claimed_by in e.guildDetails?"<b>["+e.guildDetails[d.claimed_by].tag+"]</b> "+e.guildDetails[d.claimed_by].name:"Fetching guild name...")+"</div>");var s=new Date(d.last_flipped).getTime(),c=(new Date).getTime(),w=c-s;l+='<div class="captured-since popup-detail">Flipped '+e._msToDHMSLossy(w)+" ago</div>",c-s<e.righteous_indignation_time?(o.find(".cooldown-container").show(),e.updateCircles[d.id]={flipped:s}):(o.find(".cooldown-container").hide(),delete e.updateCircles[d.id]),e._updateCooldownCircle(n,s,c,e.righteous_indignation_time),o.find(".www-obj-badge").attr("class","www-obj-badge wvw-obj-"+d.owner);var u="";d.yaks_delivered>=20&&(u+='<div class="wvw-shield-1"></div>'),d.yaks_delivered>=60&&(u+='<div class="wvw-shield-2"></div>'),d.yaks_delivered>=140?(u+='<div class="wvw-shield-3"></div>',"Keep"===d.type||"Castle"===d.type?o.find(".wvw-waypoint").show():o.find(".wvw-waypoint").hide()):o.find(".wvw-waypoint").hide(),o.find(".wvw-shield-container").html(u),l+="</div></div></div>",n.bindPopup(l,{autoPan:!1,closeButton:!1,autoPanPadding:100,maxWidth:"auto"})}}}}},e._callbackGuildDetails=function(a,t){return function(r){e.guildDetails[r.id]=r,a._popup.setContent(a._popup.getContent().replace(t,"<b>["+r.tag+"]</b> "+r.name))}},e._updateCooldownCircles=function(){var a=(new Date).getTime();for(var t in e.updateCircles){var r=wvwMap.getObjectiveMarkers()[t];e._updateCooldownCircle(r,e.updateCircles[t].flipped,a,e.righteous_indignation_time)}setTimeout(function(){e._updateCooldownCircles()},1e3)},e._updateCooldownCircle=function(a,t,r,i){var d=r-t;if(d>=i)return $(a._icon).find(".cooldown-container").hide(),void delete e.updateCircles[a];var n=360/i*d,o=$(a._icon),l=o.find(".cooldown-border");o.find(".cooldown-text").text(e._msToMS(i-d));n<=180?l.css("background-image","linear-gradient("+(90+n)+"deg, transparent 50%, red 50%),linear-gradient(90deg, red 50%, transparent 50%)"):l.css("background-image","linear-gradient("+(n-90)+"deg, transparent 50%, gray 50%),linear-gradient(90deg, red 50%, transparent 50%)")},e._msToMS=function(e){var a=Math.floor(e/6e4),t=(e%6e4/1e3).toFixed(0);return a+":"+(t<10?"0":"")+t},e._msToDHMS=function(a){var t=e._convertMS(a),r="",i=!0;return 0!==t.d&&(i=!1,r+=t.d+" day",1!==t.d&&(r+="s")),0!==t.h&&(i||(r+=", "),i=!1,r+=t.h+" hour",1!==t.h&&(r+="s")),0!==t.m&&(i||(r+=", "),i=!1,r+=t.m+" min",1!==t.m&&(r+="s")),0!==t.s&&(i||(r+=", "),i=!1,r+=t.s+" sec",1!==t.s&&(r+="s")),r},e._msToDHMSLossy=function(e){function a(e){return e>1?"s":""}var t=Math.floor(e/1e3),r=Math.floor(t/31536e3);if(r)return r+" year"+a(r);var i=Math.floor((t%=31536e3)/86400);if(i)return i+" day"+a(i);var d=Math.floor((t%=86400)/3600);if(d)return d+" hour"+a(d);var n=Math.floor((t%=3600)/60);if(n)return n+" minute"+a(n);var o=t%60;return o?o+" second"+a(o):"less than a second"},e._convertMS=function(e){var a,t,r,i;return i=Math.floor(e/1e3),r=Math.floor(i/60),i%=60,t=Math.floor(r/60),r%=60,a=Math.floor(t/24),t%=24,{d:a,h:t,m:r,s:i}},e._fetchGuildDetails=function(e,a){$.getJSON("https://api.guildwars2.com/v2/guild/"+e,a)},e.colorToId={Red:0,RedHome:0,Blue:1,BlueHome:1,Green:2,GreenHome:2},e.baseColors={green:"30, 123, 45",blue:"26, 77, 161",red:"176, 40, 34"},e.baseDarkColors={green:"20, 82, 30",blue:"19, 57, 118",red:"133, 31, 25"},e.mapNames={Center:"Eternal Battlegrounds",RedHome:"Red Border",BlueHome:"Blue Border",GreenHome:"Green Border"},e.world_names={1001:["AR","Anvil Rock"],1002:["BP","Borlis Pass"],1003:["YB","Yak's Bend"],1004:["HoD","Henge of Denravi"],1005:["Maguuma","Maguuma"],1006:["SF","Sorrow's Furnace"],1007:["GoM","Gate of Madness"],1008:["JQ","Jade Quarry"],1009:["FA","Fort Aspenwood"],1010:["EB","Ehmry Bay"],1011:["SI","Stormbluff Isle"],1012:["DH","Darkhaven"],1013:["SoR","Sanctum of Rall"],1014:["CD","Crystal Desert"],1015:["IoJ","Isle of Janthir"],1016:["SoS","Sea of Sorrows"],1017:["TC","Tarnished Coast"],1018:["NSP","Northern Shiverpeaks"],1019:["BG","Blackgate"],1020:["FC","Ferguson's Crossing"],1021:["DB","Dragonbrand"],1022:["Kaineng","Kaineng"],1023:["DR","Devona's Rest"],1024:["ET","Eredon Terrace"],2001:["FoW","Fissure of Woe"],2002:["Deso","Desolation"],2003:["Gandara","Gandara"],2004:["Blacktide","Blacktide"],2005:["RoF","Ring of Fire"],2006:["UW","Underworld"],2007:["FSP","Far Shiverpeaks"],2008:["WR","Whiteside Ridge"],2009:["RoS","Ruins of Surmia"],2010:["SFR","Seafarer's Rest"],2011:["Vabbi","Vabbi"],2012:["PS","Piken Square"],2013:["AG","Aurora Glade"],2014:["GH","Gunnar's Hold"],2101:["JS [FR]","Jade Sea [FR]"],2102:["FR [FR]","Fort Ranik [FR]"],2103:["AR [FR]","Augury Rock [FR]"],2104:["VZ [FR]","Vizunah Square [FR]"],2105:["AS [FR]","Arborstone [FR]"],2201:["Kodash [DE]","Kodash [DE]"],2202:["RS [DE]","Riverside [DE]"],2203:["ER [DE]","Elona Reach [DE]"],2204:["AM [DE]","Abaddon's Mouth [DE]"],2205:["DL [DE]","Drakkar Lake [DE]"],2206:["MS [DE]","Miller's Sound [DE]"],2207:["DZ [DE]","Dzagonur [DE]"],2301:["BB [SP]","Baruch Bay [SP]"]},e._preInit()}